<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SEEC - Tableau de Bord</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style/style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="nav-container">
            <a href="index.html" class="logo">
                <img src="image/logo.png" alt="Logo SEEC">
                <h1>SEEC</h1>
            </a>
            
            <nav class="nav-menu">
                <a href="index.html" class="nav-link">Accueil</a>
                <a href="dashboard.html" class="nav-link active">Tableau de bord</a>
                <a href="gestion.html" class="nav-link">Gestion</a>
                <a href="contact.html" class="nav-link">Contact</a>
            </nav>
            
            <button class="mobile-menu-btn" id="mobile-menu-btn">
                <svg width="24" height="24" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/>
                </svg>
            </button>
        </div>
        
        <div class="mobile-menu" id="mobile-menu">
            <a href="index.html" class="nav-link">Accueil</a>
            <a href="dashboard.html" class="nav-link active">Tableau de bord</a>
            <a href="gestion.html" class="nav-link">Gestion</a>
            <a href="contact.html" class="nav-link">Contact</a>
        </div>
    </header>

    <!-- Main Content -->
    <main>
        <section class="section">
            <div class="container">
                <div class="text-center mb-10">
                    <h1 class="section-title">Tableau de Bord</h1>
                    <p class="section-subtitle">
                        Surveillez votre consommation électrique en temps réel et optimisez vos dépenses énergétiques.
                    </p>
                </div>

                <!-- Statistiques -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <h3 class="card-title">Consommation Totale</h3>
                                <p class="card-subtitle">Aujourd'hui</p>
                            </div>
                            <div class="text-accent">
                                <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                                </svg>
                            </div>
                        </div>
                        <div class="card-content">
                            <p class="text-3xl font-bold text-primary" id="consommation-totale">0 kWh</p>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div>
                                <h3 class="card-title">Coût Total</h3>
                                <p class="card-subtitle">Ce mois</p>
                            </div>
                            <div class="text-accent">
                                <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                        </div>
                        <div class="card-content">
                            <p class="text-3xl font-bold text-primary" id="cout-total">0 FCFA</p>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div>
                                <h3 class="card-title">Salles Actives</h3>
                                <p class="card-subtitle">En cours</p>
                            </div>
                            <div class="text-accent">
                                <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                                </svg>
                            </div>
                        </div>
                        <div class="card-content">
                            <p class="text-3xl font-bold text-primary" id="salles-actives">0</p>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div>
                                <h3 class="card-title">Appareils Actifs</h3>
                                <p class="card-subtitle">En cours</p>
                            </div>
                            <div class="text-accent">
                                <svg width="32" height="32" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z"/>
                                </svg>
                            </div>
                        </div>
                        <div class="card-content">
                            <p class="text-3xl font-bold text-primary" id="appareils-actifs">0</p>
                        </div>
                    </div>
                </div>

                <!-- Graphiques -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Évolution de la Consommation</h2>
                        </div>
                        <div class="card-content">
                            <div class="chart-container">
                                <canvas id="line-chart"></canvas>
                            </div>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h2 class="card-title">Consommation par Salle</h2>
                        </div>
                        <div class="card-content">
                            <div class="chart-container">
                                <canvas id="bar-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Top 5 des salles les plus consommatrices -->
                <div class="card mb-8">
                    <div class="card-header">
                        <h2 class="card-title">Top 5 des Salles les Plus Consommatrices</h2>
                    </div>
                    <div class="card-content">
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4" id="top-salles">
                            <!-- Les cartes des salles seront générées ici -->
                        </div>
                    </div>
                </div>

                <!-- Historique des consommations -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Historique des Consommations</h2>
                    </div>
                    <div class="card-content">
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Salle</th>
                                        <th>Appareil</th>
                                        <th>Valeur (kWh)</th>
                                        <th>Coût (FCFA)</th>
                                    </tr>
                                </thead>
                                <tbody id="consommation-history">
                                    <!-- Les données seront générées dynamiquement -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script src="script/script.js"></script>
    <script>
        // Initialisation des graphiques et données
        document.addEventListener('DOMContentLoaded', function() {
            loadDashboardData();
            initCharts();
            
            // Gestion du menu mobile
            const mobileMenuButton = document.getElementById('mobile-menu-btn');
            const mobileMenu = document.getElementById('mobile-menu');

            if (mobileMenuButton && mobileMenu) {
                mobileMenuButton.addEventListener('click', function() {
                    mobileMenu.classList.toggle('active');
                });
            }
        });

        async function loadDashboardData() {
            try {
                // Charger les salles et appareils
                const [sallesResponse, appareilsResponse] = await Promise.all([
                    fetch('api/data_handler.php?action=get&file=salles'),
                    fetch('api/data_handler.php?action=get&file=appareils')
                ]);

                const sallesResult = await sallesResponse.json();
                const appareilsResult = await appareilsResponse.json();

                if (sallesResult.success && appareilsResult.success) {
                    updateStatistics(sallesResult.data, appareilsResult.data);
                    updateTopSalles(sallesResult.data, appareilsResult.data);
                    updateConsommationHistory(sallesResult.data, appareilsResult.data);
                }
            } catch (error) {
                console.error('Erreur lors du chargement des données:', error);
            }
        }

        function updateStatistics(salles, appareils) {
            // Calculer les statistiques
            const sallesActives = salles.filter(s => s.statut_alimentation).length;
            const appareilsActifs = appareils.filter(a => a.statut_alimentation).length;
            
            // Consommation simulée basée sur les appareils actifs
            const consommationTotale = appareilsActifs * 2.5; // 2.5 kWh par appareil actif
            const coutTotal = consommationTotale * 1000; // 1000 FCFA par kWh

            // Mettre à jour l'affichage
            document.getElementById('salles-actives').textContent = sallesActives;
            document.getElementById('appareils-actifs').textContent = appareilsActifs;
            document.getElementById('consommation-totale').textContent = consommationTotale.toFixed(1) + ' kWh';
            document.getElementById('cout-total').textContent = coutTotal.toLocaleString() + ' FCFA';
        }

        function updateTopSalles(salles, appareils) {
            const topSallesContainer = document.getElementById('top-salles');
            topSallesContainer.innerHTML = '';

            // Calculer la consommation par salle
            const consommationParSalle = salles.map(salle => {
                const appareilsSalle = appareils.filter(a => a.salle_id === salle.id && a.statut_alimentation);
                const consommation = appareilsSalle.length * 2.5; // 2.5 kWh par appareil
                return { ...salle, consommation };
            });

            // Trier par consommation et prendre le top 5
            const top5 = consommationParSalle
                .sort((a, b) => b.consommation - a.consommation)
                .slice(0, 5);

            top5.forEach((salle, index) => {
                const card = document.createElement('div');
                card.className = 'card bg-gradient-to-br from-primary/10 to-primary/5 border border-primary/20';
                card.innerHTML = `
                    <div class="card-content text-center">
                        <div class="text-2xl font-bold text-primary mb-2">#${index + 1}</div>
                        <h3 class="font-semibold text-white mb-1">${salle.nom}</h3>
                        <p class="text-sm text-gray-400">Étage ${salle.etage}</p>
                        <p class="text-lg font-bold text-accent mt-2">${salle.consommation.toFixed(1)} kWh</p>
                    </div>
                `;
                topSallesContainer.appendChild(card);
            });
        }

        function updateConsommationHistory(salles, appareils) {
            const historyContainer = document.getElementById('consommation-history');
            historyContainer.innerHTML = '';

            // Générer des données d'historique simulées
            const today = new Date();
            const historyData = [];

            for (let i = 0; i < 7; i++) {
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                
                const appareilsActifs = appareils.filter(a => a.statut_alimentation).length;
                const consommation = appareilsActifs * 2.5 * (0.8 + Math.random() * 0.4); // Variation aléatoire
                const cout = consommation * 1000;

                historyData.push({
                    date: date.toISOString().split('T')[0],
                    consommation: consommation,
                    cout: cout
                });
            }

            // Afficher l'historique
            historyData.forEach(entry => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${entry.date}</td>
                    <td>Toutes les salles</td>
                    <td>Tous les appareils</td>
                    <td>${entry.consommation.toFixed(1)}</td>
                    <td>${entry.cout.toLocaleString()}</td>
                `;
                historyContainer.appendChild(row);
            });
        }

        function initCharts() {
            // Graphique linéaire - Évolution de la consommation
            const lineCtx = document.getElementById('line-chart').getContext('2d');
            new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'],
                    datasets: [{
                        label: 'Consommation (kWh)',
                        data: [65, 59, 80, 81, 56, 55, 40],
                        borderColor: '#4F46E5',
                        backgroundColor: 'rgba(79, 70, 229, 0.1)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#E5E7EB'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#E5E7EB'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#E5E7EB'
                            }
                        }
                    }
                }
            });

            // Graphique en barres - Consommation par salle
            const barCtx = document.getElementById('bar-chart').getContext('2d');
            new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: ['Bureau 101', 'Bureau 102', 'Bureau 301', 'Réunion A', 'Réunion B'],
                    datasets: [{
                        label: 'Consommation (kWh)',
                        data: [12.5, 10.0, 15.0, 7.5, 7.5],
                        backgroundColor: 'rgba(79, 70, 229, 0.8)',
                        borderColor: 'rgba(79, 70, 229, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#E5E7EB'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: '#E5E7EB'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#E5E7EB'
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html> 